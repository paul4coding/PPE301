{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Calendrier des Rendez-vous | Tableau de bord</title>
    <meta content="" name="description" />
    <meta content="" name="author" />
    <link rel="shortcut icon" href="{% static 'admin/assets/images/favicon.png' %}" type="image/x-icon" />
    <link rel="apple-touch-icon-precomposed" href="{% static 'admin/assets/images/apple-touch-icon-57-precomposed.png' %}">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="{% static 'admin/assets/images/apple-touch-icon-114-precomposed.png' %}">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="{% static 'admin/assets/images/apple-touch-icon-72-precomposed.png' %}">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="{% static 'admin/assets/images/apple-touch-icon-144-precomposed.png' %}">
    <link href="{% static 'admin/assets/plugins/pace/pace-theme-flash.css' %}" rel="stylesheet" type="text/css" media="screen" />
    <link href="{% static 'admin/assets/plugins/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'admin/assets/plugins/bootstrap/css/bootstrap-theme.min.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'admin/assets/fonts/font-awesome/css/font-awesome.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'admin/assets/fonts/webfont/cryptocoins.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'admin/assets/css/animate.min.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'admin/assets/plugins/perfect-scrollbar/perfect-scrollbar.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'admin/assets/css/style.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'admin/assets/css/responsive.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'js/main.min.css' %}" rel="stylesheet" />
    <style>
        #calendar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    {% include "admin_template/partials/_header.html" %}
    <div class="page-container row-fluid container-fluid">
        {% include "admin_template/partials/_sidebar.html" %}
        <section id="main-content" class="">
            <div class="wrapper main-wrapper row" style="">
                <div class="col-xs-12">
                    <div class="page-title">
                        <div class="pull-left">
                            <h1 class="title">Calendrier des Rendez-vous</h1>
                        </div>
                        <div class="pull-right hidden-xs">
                            <ol class="breadcrumb">
                                <li>
                                    <a href="{% url 'admin_home' %}"><i class="fa fa-home"></i>Accueil</a>
                                </li>
                                <li class="active">
                                    <strong>Calendrier des Rendez-vous</strong>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>
                <div class="clearfix"></div>
                <div class="col-xs-12">
                    {% if messages %}
                      {% for message in messages %}
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                          {{ message }}
                          <button type="button" class="close" data-dismiss="alert" aria-label="Fermer">
                            <span aria-hidden="true">&times;</span>
                          </button>
                        </div>
                      {% endfor %}
                    {% endif %}
                    <div class="alert alert-info mt-3" id="rdvCountInfo">
                        Chargement des rendez-vous...
                    </div>
                </div>
                <div class="col-xs-12 mt-4">
                    <div id="calendar"></div>
                </div>
            </div>
        </section>
    </div>

    <!-- Modal pour le d√©tail et modification du rendez-vous -->
    <div class="modal fade" id="rdvDetailModal" tabindex="-1" role="dialog" aria-labelledby="rdvDetailModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-primary">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="rdvDetailModalLabel">D√©tail du rendez-vous</h5>
            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Fermer">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body text-dark" id="rdvDetailContent">
            <!-- Le contenu sera inject√© dynamiquement -->
          </div>
          <div class="modal-footer">
            <form id="rdvStatutForm" class="form-inline" method="post" action="{% url 'set_rdv_status' %}" style="width:100%;display:none;">
              {% csrf_token %}
              <input type="hidden" id="rdvIdInput" name="rdv_id" value="">
              <label for="statutSelect" class="mr-2">Changer le statut :</label>
              <select id="statutSelect" name="statut" class="form-control mr-2">
                <option value="en_attente">En attente</option>
                <option value="confirm√©">Confirm√©</option>
                <option value="annul√©">Annul√©</option>
              </select>
              <button type="submit" class="btn btn-success">Sauvegarder</button>
            </form>
            <button type="button" class="btn btn-outline-primary" data-dismiss="modal">Fermer</button>
          </div>
        </div>
      </div>
    </div>

    {% if popup_message %}
    <div class="modal fade" id="popupRdvModal" tabindex="-1" role="dialog" aria-labelledby="popupRdvModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-primary">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="popupRdvModalLabel">üìÖ Notification de Rendez-vous</h5>
            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Fermer">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body text-dark">
            {{ popup_message }}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-primary" data-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="{% static 'admin/assets/plugins/bootstrap/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'js/index.global.min.js' %}"></script>
    <script src="{% static 'admin/assets/js/jquery.easing.min.js' %}"></script>
    <script src="{% static 'admin/assets/plugins/pace/pace.min.js' %}"></script>
    <script src="{% static 'admin/assets/plugins/perfect-scrollbar/perfect-scrollbar.min.js' %}"></script>
    <script src="{% static 'admin/assets/plugins/viewport/viewportchecker.js' %}"></script>
    <script src="{% static 'admin/assets/js/scripts.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    var calendarEl = document.getElementById('calendar');
    var rdvCountInfo = document.getElementById('rdvCountInfo');
    if (!calendarEl) return;
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'fr',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        height: 'auto',
        events: {
            url: "{% url 'api_rendezvous' %}",
            failure: function() {
                if (rdvCountInfo) {
                    rdvCountInfo.textContent = "Impossible de charger les rendez-vous.";
                    rdvCountInfo.className = "alert alert-danger mt-3";
                }
            },
            success: function(data) {
                if (rdvCountInfo) {
                    rdvCountInfo.textContent = "Nombre de rendez-vous charg√©s : " + data.length;
                    rdvCountInfo.className = "alert alert-info mt-3";
                }
            }
        },
        eventClick: function(info) {
            var props = info.event.extendedProps;
            var rdvId = info.event.id;
            var statut = props.statut || 'en_attente';
            var statutDisplay = '';
            if (statut === 'en_attente') statutDisplay = 'En attente';
            else if (statut === 'confirm√©') statutDisplay = 'Confirm√©';
            else if (statut === 'annul√©') statutDisplay = 'Annul√©';
            else statutDisplay = statut || '-';
            var content = `
                <strong>Patient :</strong> ${props.patient}<br>
                <strong>M√©decin :</strong> ${props.medecin}<br>
                <strong>Motif :</strong> ${props.motif}<br>
                <strong>Statut actuel :</strong> <span id="rdvStatutLabel">${statutDisplay}</span><br>
                <strong>Date :</strong> ${props.date} √† ${props.heure}<br>
                
            `;
            $('#rdvDetailContent').html(content);
            $('#rdvIdInput').val(rdvId);
            $('#statutSelect').val(statut);
            $('#rdvStatutForm').show();
            $('#rdvDetailModal').modal('show');
        }
    });
    calendar.render();

    // Afficher/Masquer le formulaire √† la fermeture de la modale
    $('#rdvDetailModal').on('hidden.bs.modal', function () {
        $('#rdvStatutForm').hide();
        $('#rdvStatutForm')[0].reset();
    });

    {% if popup_message %}
    $('#popupRdvModal').modal('show');
    {% endif %}
});
</script>
</body>
</html>
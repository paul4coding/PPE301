{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Détail de la facture</title>
    <meta content="" name="description" />
    <meta content="" name="author" />
    <!-- Favicon et CSS (identiques à la liste) -->
    <link rel="shortcut icon" href="{% static 'admin/assets/images/favicon.png' %}" type="image/x-icon" />
    <link rel="apple-touch-icon-precomposed" href="{% static 'admin/assets/images/apple-touch-icon-57-precomposed.png' %}">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="{% static 'admin/assets/images/apple-touch-icon-114-precomposed.png' %}">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="{% static 'admin/assets/images/apple-touch-icon-72-precomposed.png' %}">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="{% static 'admin/assets/images/apple-touch-icon-144-precomposed.png' %}">
    <link href="{% static 'admin/assets/plugins/pace/pace-theme-flash.css' %}" rel="stylesheet" type="text/css" media="screen" />
    <link href="{% static 'admin/assets/plugins/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'admin/assets/plugins/bootstrap/css/bootstrap-theme.min.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'admin/assets/fonts/font-awesome/css/font-awesome.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'admin/assets/fonts/webfont/cryptocoins.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'admin/assets/css/animate.min.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'admin/assets/plugins/perfect-scrollbar/perfect-scrollbar.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'admin/assets/css/style.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'admin/assets/css/responsive.css' %}" rel="stylesheet" type="text/css" />
    <style>
        .bilan-section { margin-bottom: 30px; }
        .bilan-card { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 15px; }
        .bilan-title { font-size: 1.2em; color: #007bff; margin-bottom: 10px; }
        .bilan-label { font-weight: bold; }
        .bilan-hr { border-top: 2px solid #e0e0e0; margin: 30px 0 20px 0; }
    </style>
</head>
<body>
    {% include "admin_template/partials/_header.html" %}
    <div class="page-container row-fluid container-fluid">
        {% include "admin_template/partials/_sidebar.html" %}
        <section id="main-content">
            <div class="wrapper main-wrapper row">
                <div class="col-md-10 col-md-offset-1">
                    <div class="page-title">
                        <h1 class="title">Détail de la facture #{{ facture.id }}</h1>
                    </div>
                    <section class="box">
                        <div class="content-body p">
                            {% if messages %}
                              <ul class="messages">{% for message in messages %}<li>{{ message }}</li>{% endfor %}</ul>
                            {% endif %}
                            <p><strong>Patient :</strong> {{ facture.patient }}</p>
                            <p><strong>Date :</strong> {{ facture.date }}</p>
                            <p><strong>Statut :</strong> {{ facture.get_statut_display }}</p>
                            <p><strong>Montant total :</strong> {{ total }} fcfa</p>
                            <h3>Lignes de facture</h3>
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Service</th>
                                        <th>Prix</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ligne in lignes %}
                                    <tr>
                                        <td>{{ ligne.description }}</td>
                                        <td>{{ ligne.service }}</td>
                                        <td>{{ ligne.prix }} fcfa</td>
                                        <td>
                                            <a href="{% url 'ajouter_resultat' ligne.id %}" class="btn btn-xs btn-info">Résultat</a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% if role == "secretaire" and facture.statut == "brouillon" %}
                            <form method="post" action="{% url 'changer_statut_facture' facture.id %}">
                              {% csrf_token %}
                              <button name="action" value="valider" class="btn btn-success">Valider la facture</button>
                            </form>
                            {% endif %}
                            {% if role == "medecin" and facture.statut == "validee" %}
                            <form method="post" action="{% url 'changer_statut_facture' facture.id %}">
                              {% csrf_token %}
                              <button name="action" value="transfert_secretaire" class="btn btn-primary">Transférer à la secrétaire</button>
                            </form>
                            {% endif %}
                            {% if role == "secretaire" and facture.statut == "attente_secretaire" %}
                            <form method="post" action="{% url 'changer_statut_facture' facture.id %}">
                              {% csrf_token %}
                              <button name="action" value="transfert_laborantin" class="btn btn-warning">Transférer au laborantin</button>
                            </form>
                            {% endif %}
                            {% if role == "laborantin" and facture.statut == "attente_laborantin" %}
                            <form method="post" action="{% url 'changer_statut_facture' facture.id %}">
                              {% csrf_token %}
                              <button name="action" value="transfert_medecin" class="btn btn-info">Transférer au médecin</button>
                            </form>
                            {% endif %}
                            {% if role == "medecin" and facture.statut == "attente_medecin" %}
                            <form method="post" action="{% url 'changer_statut_facture' facture.id %}">
                              {% csrf_token %}
                              <button name="action" value="cloturer" class="btn btn-danger">Clôturer la facture</button>
                            </form>
                            <!-- Bouton pour renvoyer à la secrétaire pour analyse complémentaire ou ajout de ligne -->
                            <form method="post" action="{% url 'changer_statut_facture' facture.id %}" style="display:inline;">
                              {% csrf_token %}
                              <button name="action" value="transfert_secretaire" class="btn btn-primary">
                                Renvoyer à la secrétaire 
                              </button>
                            </form>
                            {% endif %}
                            <a href="{% url 'ajouter_ligne_facture' facture.id %}" class="btn btn-primary">Ajouter une ligne</a>
                            <a href="{% url 'liste_factures' %}" class="btn btn-default">Retour à la liste des factures</a>
                            <hr class="bilan-hr">

                            <!-- Résultats et prescriptions joliment affichés -->
                            <div class="bilan-section">
                                <div class="bilan-title"><i class="fa fa-vials"></i> Résultats &amp; Prescriptions</div>
                                {% for ligne in lignes %}
                                    {% for resultat in ligne.resultats.all %}
                                        <div class="bilan-card">
                                            <span class="bilan-label">Service :</span> {{ ligne.service }}<br>
                                            <span class="bilan-label">Résultat :</span> {{ resultat.resultat|linebreaksbr }}
                                            {% if role == 'laborantin' %}
                                                <a href="{% url 'edit_resultat' resultat.id %}" class="btn btn-xs btn-warning ml-2">Modifier</a>
                                                <a href="{% url 'delete_resultat' resultat.id %}" class="btn btn-xs btn-danger ml-2">Supprimer</a>
                                            {% endif %}
                                            <hr>
                                            <span class="bilan-label">Prescriptions :</span>
                                            {% for prescription in resultat.prescriptions.all %}
                                                <div style="margin-left:15px;">
                                                    <span class="bilan-label">Médicaments :</span> {{ prescription.liste_medicaments|linebreaksbr }}<br>
                                                    <span class="bilan-label">Posologie :</span> {{ prescription.posologie|linebreaksbr }}
                                                    {% if role == 'medecin' %}
                                                        <a href="{% url 'edit_prescription' prescription.id %}" class="btn btn-xs btn-warning ml-2">Modifier</a>
                                                        <a href="{% url 'delete_prescription' prescription.id %}" class="btn btn-xs btn-danger ml-2">Supprimer</a>
                                                    {% endif %}
                                                </div>
                                                <hr>
                                            {% empty %}
                                                <div class="ml-3 text-muted">Aucune prescription</div>
                                            {% endfor %}
                                            {% if role == 'medecin' and facture.statut == 'attente_medecin' %}
                                                <a href="{% url 'ajouter_prescription' resultat.id %}" class="btn btn-xs btn-success ml-2">Ajouter prescription</a>
                                            {% endif %}
                                        </div>
                                    {% empty %}
                                        <div class="ml-3 text-muted">Aucun résultat</div>
                                    {% endfor %}
                                {% endfor %}
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </section>
    </div>
    <!-- CORE JS FRAMEWORK - START -->
    <script src="{% static 'admin/assets/js/jquery.min.js' %}"></script>
    <script src="{% static 'admin/assets/js/jquery.easing.min.js' %}"></script>
    <script src="{% static 'admin/assets/plugins/bootstrap/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'admin/assets/plugins/pace/pace.min.js' %}"></script>
    <script src="{% static 'admin/assets/plugins/perfect-scrollbar/perfect-scrollbar.min.js' %}"></script>
    <script src="{% static 'admin/assets/plugins/viewport/viewportchecker.js' %}"></script>
    <script>
        window.jQuery || document.write('<script src="{% static 'admin/assets/js/jquery.min.js' %}"><\/script>');
    </script>
    <!-- CORE JS FRAMEWORK - END -->
    <script src="{% static 'admin/assets/js/scripts.js' %}"></script>
</body>
</html>